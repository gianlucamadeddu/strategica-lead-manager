<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STRATEGICA Lead Manager</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS per Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f1f5f9;
            min-height: 100vh;
        }
        
        /* LOGIN PAGE */
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 420px;
            overflow: hidden;
        }
        
        .login-header {
            background: linear-gradient(135deg, #0067A0 0%, #004d7a 100%);
            padding: 40px 32px;
            text-align: center;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 16px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .login-logo span {
            color: #0067A0;
            font-weight: 800;
            font-size: 24px;
        }
        
        .login-header h1 {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .login-header p {
            color: rgba(255,255,255,0.85);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .login-form {
            padding: 40px 32px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .input-wrapper svg {
            position: absolute;
            left: 14px;
            color: #9ca3af;
            width: 20px;
            height: 20px;
        }
        
        .input-wrapper input {
            width: 100%;
            padding: 14px 14px 14px 46px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s;
            outline: none;
        }
        
        .input-wrapper input:focus {
            border-color: #0067A0;
        }
        
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #0067A0 0%, #004d7a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 103, 160, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 103, 160, 0.4);
        }
        
        .login-error {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        /* MAIN APP */
        .app-container {
            display: none;
            min-height: 100vh;
        }
        
        .app-container.active {
            display: flex;
        }
        
        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #0067A0 0%, #004d7a 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar-logo-icon {
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-logo-icon span {
            color: #0067A0;
            font-weight: 800;
            font-size: 18px;
        }
        
        .sidebar-logo-text {
            color: white;
            font-weight: 700;
            font-size: 16px;
        }
        
        .sidebar-logo-sub {
            color: rgba(255,255,255,0.7);
            font-size: 11px;
            letter-spacing: 1px;
        }
        
        .sidebar-nav {
            padding: 20px 12px;
            flex: 1;
        }
        
        .nav-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin-bottom: 6px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .nav-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: 600;
        }
        
        .nav-item svg {
            width: 20px;
            height: 20px;
        }
        
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #e6165c;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }
        
        .user-name {
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-role {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
        }
        
        .btn-logout {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: rgba(255,255,255,0.9);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-logout:hover {
            background: rgba(255,255,255,0.15);
        }
        
        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .topbar {
            background: white;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .topbar h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .topbar p {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .search-box svg {
            position: absolute;
            left: 12px;
            color: #9ca3af;
            width: 16px;
            height: 16px;
        }
        
        .search-box input {
            padding: 10px 14px 10px 40px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            width: 240px;
            outline: none;
        }
        
        .search-box input:focus {
            border-color: #0067A0;
        }
        
        .btn-icon {
            position: relative;
            width: 42px;
            height: 42px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
        
        .btn-icon:hover {
            background: #f1f5f9;
        }
        
        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #e6165c;
            border-radius: 50%;
        }
        
        .btn-accent {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #e6165c;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(230, 22, 92, 0.3);
            transition: all 0.2s;
        }
        
        .btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(230, 22, 92, 0.4);
        }
        
        .content-area {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
        }
        
        /* SECTIONS */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* PIPELINE */
        .pipeline-container {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 4px;
        }
        
        .pipeline-column {
            flex: 1;
            min-width: 160px;
            max-width: 180px;
            background: #f8fafc;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
        }
        
        .pipeline-header {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .pipeline-title {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .pipeline-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .pipeline-icon svg {
            width: 12px;
            height: 12px;
        }
        
        .pipeline-name {
            font-weight: 600;
            font-size: 11px;
            color: #1f2937;
        }
        
        .pipeline-count {
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }
        
        .pipeline-cards {
            padding: 8px;
            flex: 1;
            min-height: 200px;
            overflow-y: auto;
        }
        
        .pipeline-cards.drag-over {
            background: #e0f2fe;
        }
        
        /* LEAD CARD */
        .lead-card {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            cursor: grab;
            transition: all 0.2s;
        }
        
        .lead-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .lead-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .lead-company {
            font-weight: 600;
            font-size: 12px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 8px;
        }
        
        .lead-company svg {
            width: 14px;
            height: 14px;
            color: #6b7280;
        }
        
        .lead-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 11px;
            color: #6b7280;
        }
        
        .lead-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .lead-detail svg {
            width: 12px;
            height: 12px;
        }
        
        .lead-collaborator {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .lead-collab-avatar {
            width: 18px;
            height: 18px;
            background: #0067A0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: 600;
        }
        
        .lead-collab-name {
            font-size: 10px;
            color: #6b7280;
        }
        
        /* STATS CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }
        
        .stat-icon {
            width: 24px;
            height: 24px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .stat-change {
            font-size: 13px;
            margin-top: 4px;
        }
        
        .stat-change.positive {
            color: #22c55e;
        }
        
        /* TABLE */
        .data-table-container {
            background: white;
            border-radius: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        
        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            padding: 14px 24px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f8fafc;
        }
        
        .data-table td {
            padding: 16px 24px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            color: #1f2937;
        }
        
        .data-table tr:hover {
            background: #f9fafb;
        }
        
        .table-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .table-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .badge-success {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .badge-primary {
            background: #dbeafe;
            color: #2563eb;
        }
        
        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .btn-secondary {
            padding: 10px 20px;
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-submit {
            padding: 10px 20px;
            background: #0067A0;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .btn-submit:hover {
            background: #005580;
        }
        
        /* FORM STYLES */
        .form-row {
            margin-bottom: 20px;
        }
        
        .form-row label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-row input,
        .form-row select,
        .form-row textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        
        .form-row input:focus,
        .form-row select:focus,
        .form-row textarea:focus {
            border-color: #0067A0;
        }
        
        .form-row textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* IMPORT SECTION */
        .upload-area {
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-area:hover {
            border-color: #0067A0;
            background: #f8fafc;
        }
        
        .upload-area svg {
            width: 48px;
            height: 48px;
            color: #9ca3af;
            margin-bottom: 16px;
        }
        
        .upload-area h3 {
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .upload-area p {
            color: #6b7280;
            font-size: 14px;
        }
        
        /* SETTINGS */
        .settings-section {
            background: white;
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }
        
        .settings-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-title svg {
            width: 20px;
            height: 20px;
            color: #0067A0;
        }
        
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .settings-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .settings-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .settings-item-icon svg {
            width: 16px;
            height: 16px;
        }
        
        .settings-item-text {
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
        }
        
        .settings-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }
        
        .btn-edit {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .btn-delete {
            background: #fee2e2;
            color: #dc2626;
        }
        
        /* FILTERS */
        .filters-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-label {
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
        }
        
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        
        .filter-input:focus {
            border-color: #0067A0;
        }
        
        /* TOAST NOTIFICATION */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #1f2937;
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 2000;
        }
        
        .toast.active {
            display: flex;
        }
        
        .toast.success {
            background: #22c55e;
        }
        
        .toast.error {
            background: #ef4444;
        }
        
        .toast svg {
            width: 20px;
            height: 20px;
        }
        
        /* LEAD DETAIL MODAL */
        .lead-history {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .history-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .history-item {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 13px;
        }
        
        .history-date {
            color: #6b7280;
            min-width: 140px;
        }
        
        .history-action {
            color: #1f2937;
        }
        
        /* HIDDEN */
        .hidden {
            display: none !important;
        }
        
        /* COLLABORATOR VIEW */
        .collab-nav-item {
            display: none;
        }
        
        .admin-only {
            display: block;
        }
        
        body.collaborator-view .admin-only {
            display: none !important;
        }
        
        body.collaborator-view .collab-nav-item {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo" style="width:auto; height:auto; padding:16px;">
                    <img src="logo_Strategica.jpg" alt="Strategica" style="height:50px; width:auto;">
                </div>
                <h1>Lead Manager</h1>
                <p>CRM Call Center</p>
            </div>
            <div class="login-form">
                <div class="login-error" id="loginError">
                    Username o password non corretti
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <div class="input-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <input type="text" id="loginUsername" placeholder="Inserisci username">
                    </div>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="input-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        <input type="password" id="loginPassword" placeholder="Inserisci password">
                    </div>
                </div>
                <button class="btn-primary" onclick="handleLogin()">Accedi</button>
            </div>
        </div>
    </div>
    
    <!-- MAIN APP -->
    <div class="app-container" id="appContainer">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header" style="padding: 20px 16px;">
                <div class="sidebar-logo" style="justify-content: center;">
                    <img src="logo_Strategica.jpg" alt="Strategica" style="width: 100%; max-width: 200px; height: auto;">
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <button class="nav-item active" data-section="pipeline">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="6" height="14" x="3" y="5" rx="1"/>
                        <rect width="6" height="10" x="9" y="9" rx="1"/>
                        <rect width="6" height="16" x="15" y="3" rx="1"/>
                    </svg>
                    Pipeline
                </button>
                <button class="nav-item" data-section="leads">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Lista Lead
                </button>
                <button class="nav-item admin-only" data-section="performance">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" x2="12" y1="20" y2="10"/>
                        <line x1="18" x2="18" y1="20" y2="4"/>
                        <line x1="6" x2="6" y1="20" y2="16"/>
                    </svg>
                    Performance
                </button>
                <button class="nav-item admin-only" data-section="import">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" x2="12" y1="3" y2="15"/>
                    </svg>
                    Import Lead
                </button>
                <button class="nav-item admin-only" data-section="export">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" x2="12" y1="15" y2="3"/>
                    </svg>
                    Export
                </button>
                <button class="nav-item admin-only" data-section="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Impostazioni
                </button>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">AD</div>
                    <div>
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role" id="userRole">Amministratore</div>
                    </div>
                </div>
                <button class="btn-logout" onclick="handleLogout()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" x2="9" y1="12" y2="12"/>
                    </svg>
                    Logout
                </button>
            </div>
        </aside>
        
        <!-- MAIN CONTENT -->
        <main class="main-content">
            <header class="topbar">
                <div>
                    <h1 id="pageTitle">Pipeline Lead</h1>
                    <p id="pageSubtitle">Gestisci i tuoi lead con drag & drop</p>
                </div>
                <div class="topbar-actions">
                    <div class="search-box">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.3-4.3"/>
                        </svg>
                        <input type="text" placeholder="Cerca lead..." id="globalSearch" onkeyup="handleGlobalSearch()">
                    </div>
                    <button class="btn-icon" id="notificationBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                            <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                        </svg>
                        <span class="notification-badge hidden" id="notificationBadge"></span>
                    </button>
                    <button class="btn-accent admin-only" onclick="openNewLeadModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                            <path d="M5 12h14"/>
                            <path d="M12 5v14"/>
                        </svg>
                        Nuovo Lead
                    </button>
                </div>
            </header>
            
            <div class="content-area">
                <!-- PIPELINE SECTION -->
                <section class="section active" id="pipelineSection">
                    <div class="pipeline-container" id="pipelineContainer">
                        <!-- Pipeline columns will be rendered here -->
                    </div>
                </section>
                
                <!-- LEADS LIST SECTION -->
                <section class="section" id="leadsSection">
                    <div class="filters-bar">
                        <div class="filter-group">
                            <label class="filter-label">Nome Azienda</label>
                            <input type="text" class="filter-input" id="filterCompany" placeholder="Cerca..." onkeyup="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Città</label>
                            <input type="text" class="filter-input" id="filterCity" placeholder="Cerca..." onkeyup="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Fatturato Min</label>
                            <input type="number" class="filter-input" id="filterRevenueMin" placeholder="€" onchange="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Fatturato Max</label>
                            <input type="number" class="filter-input" id="filterRevenueMax" placeholder="€" onchange="applyFilters()">
                        </div>
                    </div>
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3 class="table-title">Tutti i Lead</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Azienda</th>
                                    <th>Città</th>
                                    <th>Fatturato</th>
                                    <th>Telefono</th>
                                    <th>Stato</th>
                                    <th>Collaboratore</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="leadsTableBody">
                                <!-- Leads will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <!-- PERFORMANCE SECTION -->
                <section class="section" id="performanceSection">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Chiamate Totali</span>
                                <svg class="stat-icon" style="color: #0067A0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                </svg>
                            </div>
                            <div class="stat-value" id="totalCalls">0</div>
                            <div class="stat-change positive">Totale movimenti lead</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Lead OK</span>
                                <svg class="stat-icon" style="color: #22c55e" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <circle cx="12" cy="12" r="6"/>
                                    <circle cx="12" cy="12" r="2"/>
                                </svg>
                            </div>
                            <div class="stat-value" id="totalLeadsOK">0</div>
                            <div class="stat-change positive">Lead convertiti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Conversione Media</span>
                                <svg class="stat-icon" style="color: #e6165c" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/>
                                    <polyline points="16 7 22 7 22 13"/>
                                </svg>
                            </div>
                            <div class="stat-value" id="avgConversion">0%</div>
                            <div class="stat-change">Target: 10%</div>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-header">
                            <h3 class="table-title">Performance Collaboratori</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Collaboratore</th>
                                    <th style="text-align:center">Lead Assegnati</th>
                                    <th style="text-align:center">Lead OK</th>
                                    <th style="text-align:center">Conversione</th>
                                </tr>
                            </thead>
                            <tbody id="performanceTableBody">
                                <!-- Performance data will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <!-- IMPORT SECTION -->
                <section class="section" id="importSection">
                    <div class="settings-section">
                        <h3 class="settings-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" x2="12" y1="3" y2="15"/>
                            </svg>
                            Importa Lead da Excel
                        </h3>
                        
                        <div class="form-row">
                            <label>Assegna a Collaboratore</label>
                            <select id="importCollaborator">
                                <!-- Options will be populated -->
                            </select>
                        </div>
                        
                        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" x2="12" y1="3" y2="15"/>
                            </svg>
                            <h3>Clicca per caricare un file Excel</h3>
                            <p>Formati supportati: .xlsx, .xls</p>
                            <p style="margin-top:12px; font-size:12px; color:#9ca3af;">Colonne richieste: Nome Azienda, Città, Fatturato, Telefono 1, Telefono 2, Telefono 3</p>
                        </div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" onchange="handleFileImport(event)">
                    </div>
                </section>
                
                <!-- EXPORT SECTION -->
                <section class="section" id="exportSection">
                    <div class="settings-section">
                        <h3 class="settings-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" x2="12" y1="15" y2="3"/>
                            </svg>
                            Esporta Dati
                        </h3>
                        
                        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                            <button class="btn-submit" onclick="exportLeadsOK()">
                                Esporta Lead OK (Excel)
                            </button>
                            <button class="btn-secondary" onclick="exportAllLeads()">
                                Esporta Tutti i Lead (Excel)
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- SETTINGS SECTION -->
                <section class="section" id="settingsSection">
                    <!-- Collaboratori -->
                    <div class="settings-section">
                        <h3 class="settings-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            Gestione Collaboratori
                        </h3>
                        <button class="btn-submit" style="margin-bottom:20px" onclick="openNewUserModal()">
                            + Aggiungi Collaboratore
                        </button>
                        <div class="settings-list" id="collaboratorsList">
                            <!-- Collaborators will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Stati Pipeline -->
                    <div class="settings-section">
                        <h3 class="settings-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect width="6" height="14" x="3" y="5" rx="1"/>
                                <rect width="6" height="10" x="9" y="9" rx="1"/>
                                <rect width="6" height="16" x="15" y="3" rx="1"/>
                            </svg>
                            Stati Pipeline
                        </h3>
                        <button class="btn-submit" style="margin-bottom:20px" onclick="openNewStatusModal()">
                            + Aggiungi Stato
                        </button>
                        <div class="settings-list" id="statusesList">
                            <!-- Statuses will be rendered here -->
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- MODALS -->
    
    <!-- New Lead Modal -->
    <div class="modal-overlay" id="newLeadModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Nuovo Lead</h3>
                <button class="modal-close" onclick="closeModal('newLeadModal')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                        <path d="M18 6 6 18"/>
                        <path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label>Nome Azienda *</label>
                    <input type="text" id="leadCompany">
                </div>
                <div class="form-row">
                    <label>Città</label>
                    <input type="text" id="leadCity">
                </div>
                <div class="form-row">
                    <label>Fatturato (€)</label>
                    <input type="number" id="leadRevenue">
                </div>
                <div class="form-row">
                    <label>Telefono 1</label>
                    <input type="text" id="leadPhone1">
                </div>
                <div class="form-row">
                    <label>Telefono 2</label>
                    <input type="text" id="leadPhone2">
                </div>
                <div class="form-row">
                    <label>Telefono 3</label>
                    <input type="text" id="leadPhone3">
                </div>
                <div class="form-row">
                    <label>Assegna a Collaboratore</label>
                    <select id="leadCollaborator">
                        <!-- Options will be populated -->
                    </select>
                </div>
                <div class="form-row">
                    <label>Note</label>
                    <textarea id="leadNotes" placeholder="Note opzionali..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('newLeadModal')">Annulla</button>
                <button class="btn-submit" onclick="saveLead()">Salva Lead</button>
            </div>
        </div>
    </div>
    
    <!-- Lead Detail Modal -->
    <div class="modal-overlay" id="leadDetailModal">
        <div class="modal" style="max-width:600px">
            <div class="modal-header">
                <h3 class="modal-title" id="detailModalTitle">Dettaglio Lead</h3>
                <button class="modal-close" onclick="closeModal('leadDetailModal')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                        <path d="M18 6 6 18"/>
                        <path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="leadDetailContent">
                <!-- Lead details will be rendered here -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('leadDetailModal')">Chiudi</button>
                <button class="btn-submit" onclick="saveLeadNotes()">Salva Note</button>
            </div>
        </div>
    </div>
    
    <!-- New User Modal -->
    <div class="modal-overlay" id="newUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">Nuovo Collaboratore</h3>
                <button class="modal-close" onclick="closeModal('newUserModal')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                        <path d="M18 6 6 18"/>
                        <path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label>Nome Completo *</label>
                    <input type="text" id="userFullName" placeholder="Es. Mario Rossi">
                </div>
                <div class="form-row">
                    <label>Username *</label>
                    <input type="text" id="userUsername" placeholder="Es. mario.rossi">
                </div>
                <div class="form-row">
                    <label>Password *</label>
                    <input type="password" id="userPassword" placeholder="Minimo 6 caratteri">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('newUserModal')">Annulla</button>
                <button class="btn-submit" onclick="saveUser()">Salva</button>
            </div>
        </div>
    </div>
    
    <!-- New Status Modal -->
    <div class="modal-overlay" id="newStatusModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="statusModalTitle">Nuovo Stato Pipeline</h3>
                <button class="modal-close" onclick="closeModal('newStatusModal')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                        <path d="M18 6 6 18"/>
                        <path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label>Nome Stato *</label>
                    <input type="text" id="statusName" placeholder="Es. In Attesa">
                </div>
                <div class="form-row">
                    <label>Colore</label>
                    <input type="color" id="statusColor" value="#0067A0" style="height:44px">
                </div>
                <div class="form-row">
                    <label>Ordine</label>
                    <input type="number" id="statusOrder" value="1" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('newStatusModal')">Annulla</button>
                <button class="btn-submit" onclick="saveStatus()">Salva</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <path d="m9 11 3 3L22 4"/>
        </svg>
        <span id="toastMessage">Operazione completata</span>
    </div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCmS0YhpaIRyVouZv0JBMQlxUXa9sz8pVc",
            authDomain: "strategica-lead-manager.firebaseapp.com",
            projectId: "strategica-lead-manager",
            storageBucket: "strategica-lead-manager.firebasestorage.app",
            messagingSenderId: "289500718789",
            appId: "1:289500718789:web:c6e10e46f874ab02d6b2ac"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Global State
        let currentUser = null;
        let leads = [];
        let users = [];
        let statuses = [];
        let editingLeadId = null;
        let editingUserId = null;
        let editingStatusId = null;
        
        // Default statuses
        const defaultStatuses = [
            { id: 'nuovo', name: 'Nuovo', color: '#0067A0', order: 1 },
            { id: 'non-risponde', name: 'Non risponde', color: '#f59e0b', order: 2 },
            { id: 'non-risponde-2', name: 'Non risponde 2', color: '#d97706', order: 3 },
            { id: 'non-risponde-3', name: 'Non risponde 3', color: '#b45309', order: 4 },
            { id: 'mai-reperibile', name: 'Mai reperibile', color: '#6b7280', order: 5 },
            { id: 'non-interessato', name: 'Non interessato', color: '#ef4444', order: 6 },
            { id: 'lead-ok', name: 'Lead OK', color: '#22c55e', order: 7 }
        ];
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeData();
            setupNavigation();
            setupDragAndDrop();
        });
        
        // Initialize Data
        async function initializeData() {
            // Check if statuses exist, if not create defaults
            const statusesSnapshot = await db.collection('statuses').get();
            if (statusesSnapshot.empty) {
                for (const status of defaultStatuses) {
                    await db.collection('statuses').doc(status.id).set(status);
                }
            }
            
            // Check if admin exists, if not create default
            const adminSnapshot = await db.collection('users').doc('admin').get();
            if (!adminSnapshot.exists) {
                await db.collection('users').doc('admin').set({
                    username: 'admin',
                    password: 'admin123',
                    fullName: 'Amministratore',
                    role: 'admin',
                    createdAt: new Date().toISOString()
                });
            }
            
            // Listen for real-time updates
            db.collection('statuses').orderBy('order').onSnapshot(snapshot => {
                statuses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentUser) {
                    renderPipeline();
                    renderStatusesList();
                }
            });
            
            db.collection('users').onSnapshot(snapshot => {
                users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentUser) {
                    renderCollaboratorsList();
                    populateCollaboratorSelects();
                }
            });
            
            db.collection('leads').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                leads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentUser) {
                    renderPipeline();
                    renderLeadsTable();
                    renderPerformance();
                }
            });
        }
        
        // Login Handler
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showLoginError('Inserisci username e password');
                return;
            }
            
            // Find user
            const userSnapshot = await db.collection('users').where('username', '==', username).get();
            
            if (userSnapshot.empty) {
                showLoginError('Username non trovato');
                return;
            }
            
            const userData = userSnapshot.docs[0].data();
            
            if (userData.password !== password) {
                showLoginError('Password non corretta');
                return;
            }
            
            // Login successful
            currentUser = { id: userSnapshot.docs[0].id, ...userData };
            
            // Update UI
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            
            // Set user info
            document.getElementById('userName').textContent = currentUser.fullName;
            document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Amministratore' : 'Collaboratore';
            document.getElementById('userAvatar').textContent = getInitials(currentUser.fullName);
            
            // Apply role-based visibility
            if (currentUser.role !== 'admin') {
                document.body.classList.add('collaborator-view');
            }
            
            // Render data
            renderPipeline();
            renderLeadsTable();
            renderPerformance();
            renderCollaboratorsList();
            renderStatusesList();
            populateCollaboratorSelects();
        }
        
        function showLoginError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 3000);
        }
        
        // Logout Handler
        function handleLogout() {
            currentUser = null;
            document.body.classList.remove('collaborator-view');
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }
        
        // Navigation
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    
                    // Update nav
                    navItems.forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Update sections
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    document.getElementById(section + 'Section').classList.add('active');
                    
                    // Update title
                    updatePageTitle(section);
                });
            });
        }
        
        function updatePageTitle(section) {
            const titles = {
                pipeline: { title: 'Pipeline Lead', subtitle: 'Gestisci i tuoi lead con drag & drop' },
                leads: { title: 'Lista Lead', subtitle: 'Visualizza e filtra tutti i lead' },
                performance: { title: 'Performance', subtitle: 'Monitora le performance del team' },
                import: { title: 'Import Lead', subtitle: 'Carica lead da file Excel' },
                export: { title: 'Export Dati', subtitle: 'Esporta lead e report' },
                settings: { title: 'Impostazioni', subtitle: 'Gestisci collaboratori e stati pipeline' }
            };
            
            document.getElementById('pageTitle').textContent = titles[section].title;
            document.getElementById('pageSubtitle').textContent = titles[section].subtitle;
        }
        
        // Render Pipeline
        function renderPipeline() {
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';
            
            const filteredLeads = currentUser.role === 'admin' 
                ? leads 
                : leads.filter(l => l.collaboratorId === currentUser.id);
            
            statuses.forEach(status => {
                const statusLeads = filteredLeads.filter(l => l.status === status.id);
                
                const column = document.createElement('div');
                column.className = 'pipeline-column';
                column.innerHTML = `
                    <div class="pipeline-header">
                        <div class="pipeline-title">
                            <div class="pipeline-icon" style="background: ${status.color}">
                                ${getStatusIcon(status.id)}
                            </div>
                            <span class="pipeline-name">${status.name}</span>
                        </div>
                        <span class="pipeline-count" style="background: ${status.color}">${statusLeads.length}</span>
                    </div>
                    <div class="pipeline-cards" data-status="${status.id}">
                        ${statusLeads.map(lead => renderLeadCard(lead)).join('')}
                    </div>
                `;
                container.appendChild(column);
            });
            
            setupDragAndDrop();
        }
        
        function renderLeadCard(lead) {
            const collaborator = users.find(u => u.id === lead.collaboratorId);
            return `
                <div class="lead-card" draggable="true" data-id="${lead.id}" onclick="openLeadDetail('${lead.id}')">
                    <div class="lead-company">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="16" height="20" x="4" y="2" rx="2" ry="2"/>
                            <path d="M9 22v-4h6v4"/>
                            <path d="M8 6h.01"/>
                            <path d="M16 6h.01"/>
                            <path d="M12 6h.01"/>
                            <path d="M12 10h.01"/>
                            <path d="M12 14h.01"/>
                            <path d="M16 10h.01"/>
                            <path d="M16 14h.01"/>
                            <path d="M8 10h.01"/>
                            <path d="M8 14h.01"/>
                        </svg>
                        ${lead.company}
                    </div>
                    <div class="lead-details">
                        <div class="lead-detail">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${lead.city || 'N/D'}
                        </div>
                        <div class="lead-detail">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 10h12"/>
                                <path d="M4 14h9"/>
                                <path d="M19 6a7.7 7.7 0 0 0-5.2-2A7.9 7.9 0 0 0 6 12c0 4.4 3.5 8 7.8 8 2 0 3.8-.8 5.2-2"/>
                            </svg>
                            ${formatCurrency(lead.revenue)}
                        </div>
                        <div class="lead-detail">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                            ${lead.phone1 || 'N/D'}
                        </div>
                    </div>
                    ${currentUser.role === 'admin' && collaborator ? `
                        <div class="lead-collaborator">
                            <div class="lead-collab-avatar">${getInitials(collaborator.fullName)}</div>
                            <span class="lead-collab-name">${collaborator.fullName}</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Drag and Drop
        function setupDragAndDrop() {
            const cards = document.querySelectorAll('.lead-card');
            const columns = document.querySelectorAll('.pipeline-cards');
            
            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    card.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', card.dataset.id);
                });
                
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });
            
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });
                
                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });
                
                column.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    
                    const leadId = e.dataTransfer.getData('text/plain');
                    const newStatus = column.dataset.status;
                    
                    await updateLeadStatus(leadId, newStatus);
                });
            });
        }
        
        async function updateLeadStatus(leadId, newStatus) {
            const lead = leads.find(l => l.id === leadId);
            const oldStatus = lead.status;
            
            if (oldStatus === newStatus) return;
            
            const historyEntry = {
                date: new Date().toISOString(),
                action: `Stato cambiato da "${getStatusName(oldStatus)}" a "${getStatusName(newStatus)}"`,
                user: currentUser.fullName
            };
            
            const history = lead.history || [];
            history.push(historyEntry);
            
            await db.collection('leads').doc(leadId).update({
                status: newStatus,
                history: history,
                updatedAt: new Date().toISOString()
            });
            
            // Show notification for Lead OK
            if (newStatus === 'lead-ok') {
                showToast(`Lead "${lead.company}" convertito in Lead OK!`, 'success');
                if (currentUser.role === 'admin') {
                    document.getElementById('notificationBadge').classList.remove('hidden');
                }
            }
            
            showToast('Stato aggiornato');
        }
        
        // Render Leads Table
        function renderLeadsTable() {
            const tbody = document.getElementById('leadsTableBody');
            
            let filteredLeads = currentUser.role === 'admin' 
                ? leads 
                : leads.filter(l => l.collaboratorId === currentUser.id);
            
            // Apply filters
            const companyFilter = document.getElementById('filterCompany').value.toLowerCase();
            const cityFilter = document.getElementById('filterCity').value.toLowerCase();
            const revenueMin = parseFloat(document.getElementById('filterRevenueMin').value) || 0;
            const revenueMax = parseFloat(document.getElementById('filterRevenueMax').value) || Infinity;
            
            filteredLeads = filteredLeads.filter(lead => {
                const matchCompany = !companyFilter || lead.company.toLowerCase().includes(companyFilter);
                const matchCity = !cityFilter || (lead.city && lead.city.toLowerCase().includes(cityFilter));
                const matchRevenue = lead.revenue >= revenueMin && lead.revenue <= revenueMax;
                return matchCompany && matchCity && matchRevenue;
            });
            
            tbody.innerHTML = filteredLeads.map(lead => {
                const collaborator = users.find(u => u.id === lead.collaboratorId);
                const status = statuses.find(s => s.id === lead.status);
                
                return `
                    <tr>
                        <td><strong>${lead.company}</strong></td>
                        <td>${lead.city || '-'}</td>
                        <td>${formatCurrency(lead.revenue)}</td>
                        <td>${lead.phone1 || '-'}</td>
                        <td><span class="badge" style="background: ${status?.color}20; color: ${status?.color}">${status?.name || lead.status}</span></td>
                        <td>${collaborator?.fullName || '-'}</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="openLeadDetail('${lead.id}')">Dettagli</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function applyFilters() {
            renderLeadsTable();
        }
        
        // Render Performance
        function renderPerformance() {
            const collaborators = users.filter(u => u.role !== 'admin');
            
            let totalLeadsOK = 0;
            let totalLeads = 0;
            
            const performanceData = collaborators.map(collab => {
                const collabLeads = leads.filter(l => l.collaboratorId === collab.id);
                const leadsOK = collabLeads.filter(l => l.status === 'lead-ok').length;
                const total = collabLeads.length;
                const conversion = total > 0 ? ((leadsOK / total) * 100).toFixed(1) : 0;
                
                totalLeadsOK += leadsOK;
                totalLeads += total;
                
                return { ...collab, leadsOK, total, conversion };
            });
            
            // Update stats
            document.getElementById('totalCalls').textContent = leads.reduce((sum, l) => sum + (l.history?.length || 0), 0);
            document.getElementById('totalLeadsOK').textContent = totalLeadsOK;
            document.getElementById('avgConversion').textContent = totalLeads > 0 ? ((totalLeadsOK / totalLeads) * 100).toFixed(1) + '%' : '0%';
            
            // Render table
            const tbody = document.getElementById('performanceTableBody');
            tbody.innerHTML = performanceData.map(collab => `
                <tr>
                    <td>
                        <div class="table-user">
                            <div class="table-avatar" style="background: #0067A0">${getInitials(collab.fullName)}</div>
                            <span>${collab.fullName}</span>
                        </div>
                    </td>
                    <td style="text-align:center"><strong>${collab.total}</strong></td>
                    <td style="text-align:center"><span class="badge badge-success">${collab.leadsOK}</span></td>
                    <td style="text-align:center"><strong style="color: #0067A0">${collab.conversion}%</strong></td>
                </tr>
            `).join('');
        }
        
        // Render Settings Lists
        function renderCollaboratorsList() {
            const container = document.getElementById('collaboratorsList');
            const collaborators = users.filter(u => u.role !== 'admin');
            
            if (collaborators.length === 0) {
                container.innerHTML = '<p style="color:#6b7280; font-size:14px;">Nessun collaboratore. Clicca "Aggiungi Collaboratore" per creare il primo.</p>';
                return;
            }
            
            container.innerHTML = collaborators.map(collab => `
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-icon" style="background: #0067A0">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <div>
                            <div class="settings-item-text">${collab.fullName}</div>
                            <div style="font-size:12px; color:#6b7280;">@${collab.username}</div>
                        </div>
                    </div>
                    <div class="settings-item-actions">
                        <button class="btn-small btn-edit" onclick="editUser('${collab.id}')">Modifica</button>
                        <button class="btn-small btn-delete" onclick="deleteUser('${collab.id}')">Elimina</button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderStatusesList() {
            const container = document.getElementById('statusesList');
            
            container.innerHTML = statuses.map(status => `
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-icon" style="background: ${status.color}">
                            ${getStatusIcon(status.id)}
                        </div>
                        <div class="settings-item-text">${status.name}</div>
                    </div>
                    <div class="settings-item-actions">
                        <button class="btn-small btn-edit" onclick="editStatus('${status.id}')">Modifica</button>
                        <button class="btn-small btn-delete" onclick="deleteStatus('${status.id}')">Elimina</button>
                    </div>
                </div>
            `).join('');
        }
        
        function populateCollaboratorSelects() {
            const collaborators = users.filter(u => u.role !== 'admin');
            const options = collaborators.map(c => `<option value="${c.id}">${c.fullName}</option>`).join('');
            
            const selects = ['leadCollaborator', 'importCollaborator'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Seleziona collaboratore</option>' + options;
                }
            });
        }
        
        // Modals
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function openNewLeadModal() {
            editingLeadId = null;
            document.getElementById('leadCompany').value = '';
            document.getElementById('leadCity').value = '';
            document.getElementById('leadRevenue').value = '';
            document.getElementById('leadPhone1').value = '';
            document.getElementById('leadPhone2').value = '';
            document.getElementById('leadPhone3').value = '';
            document.getElementById('leadCollaborator').value = '';
            document.getElementById('leadNotes').value = '';
            openModal('newLeadModal');
        }
        
        function openLeadDetail(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;
            
            editingLeadId = leadId;
            const collaborator = users.find(u => u.id === lead.collaboratorId);
            const status = statuses.find(s => s.id === lead.status);
            
            document.getElementById('detailModalTitle').textContent = lead.company;
            
            const content = document.getElementById('leadDetailContent');
            content.innerHTML = `
                <div class="form-row">
                    <label>Nome Azienda</label>
                    <input type="text" value="${lead.company}" disabled>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-row">
                        <label>Città</label>
                        <input type="text" value="${lead.city || ''}" disabled>
                    </div>
                    <div class="form-row">
                        <label>Fatturato</label>
                        <input type="text" value="${formatCurrency(lead.revenue)}" disabled>
                    </div>
                </div>
                <div class="form-row">
                    <label>Telefoni</label>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        ${lead.phone1 ? `<span class="badge badge-primary">${lead.phone1}</span>` : ''}
                        ${lead.phone2 ? `<span class="badge badge-primary">${lead.phone2}</span>` : ''}
                        ${lead.phone3 ? `<span class="badge badge-primary">${lead.phone3}</span>` : ''}
                    </div>
                </div>
                <div class="form-row">
                    <label>Stato Attuale</label>
                    <span class="badge" style="background: ${status?.color}20; color: ${status?.color}">${status?.name}</span>
                </div>
                <div class="form-row">
                    <label>Collaboratore</label>
                    <input type="text" value="${collaborator?.fullName || 'Non assegnato'}" disabled>
                </div>
                <div class="form-row">
                    <label>Note</label>
                    <textarea id="detailNotes">${lead.notes || ''}</textarea>
                </div>
                
                <div class="lead-history">
                    <div class="history-title">Storico Attività</div>
                    ${(lead.history || []).reverse().map(h => `
                        <div class="history-item">
                            <span class="history-date">${formatDate(h.date)}</span>
                            <span class="history-action">${h.action} - ${h.user}</span>
                        </div>
                    `).join('') || '<p style="color:#6b7280; font-size:13px;">Nessuna attività registrata</p>'}
                </div>
            `;
            
            openModal('leadDetailModal');
        }
        
        async function saveLeadNotes() {
            if (!editingLeadId) return;
            
            const notes = document.getElementById('detailNotes').value;
            
            await db.collection('leads').doc(editingLeadId).update({
                notes: notes,
                updatedAt: new Date().toISOString()
            });
            
            closeModal('leadDetailModal');
            showToast('Note salvate');
        }
        
        async function saveLead() {
            const company = document.getElementById('leadCompany').value.trim();
            
            if (!company) {
                showToast('Inserisci il nome azienda', 'error');
                return;
            }
            
            const leadData = {
                company: company,
                city: document.getElementById('leadCity').value.trim(),
                revenue: parseFloat(document.getElementById('leadRevenue').value) || 0,
                phone1: document.getElementById('leadPhone1').value.trim(),
                phone2: document.getElementById('leadPhone2').value.trim(),
                phone3: document.getElementById('leadPhone3').value.trim(),
                collaboratorId: document.getElementById('leadCollaborator').value,
                notes: document.getElementById('leadNotes').value.trim(),
                status: 'nuovo',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                history: [{
                    date: new Date().toISOString(),
                    action: 'Lead creato',
                    user: currentUser.fullName
                }]
            };
            
            await db.collection('leads').add(leadData);
            
            closeModal('newLeadModal');
            showToast('Lead creato con successo');
        }
        
        // User Management
        function openNewUserModal() {
            editingUserId = null;
            document.getElementById('userModalTitle').textContent = 'Nuovo Collaboratore';
            document.getElementById('userFullName').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userPassword').value = '';
            openModal('newUserModal');
        }
        
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            editingUserId = userId;
            document.getElementById('userModalTitle').textContent = 'Modifica Collaboratore';
            document.getElementById('userFullName').value = user.fullName;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userPassword').value = user.password;
            openModal('newUserModal');
        }
        
        async function saveUser() {
            const fullName = document.getElementById('userFullName').value.trim();
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            
            if (!fullName || !username || !password) {
                showToast('Compila tutti i campi', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('La password deve avere almeno 6 caratteri', 'error');
                return;
            }
            
            const userData = {
                fullName,
                username,
                password,
                role: 'collaborator',
                updatedAt: new Date().toISOString()
            };
            
            if (editingUserId) {
                await db.collection('users').doc(editingUserId).update(userData);
                showToast('Collaboratore aggiornato');
            } else {
                userData.createdAt = new Date().toISOString();
                await db.collection('users').add(userData);
                showToast('Collaboratore creato');
            }
            
            closeModal('newUserModal');
        }
        
        async function deleteUser(userId) {
            if (!confirm('Sei sicuro di voler eliminare questo collaboratore?')) return;
            
            await db.collection('users').doc(userId).delete();
            showToast('Collaboratore eliminato');
        }
        
        // Status Management
        function openNewStatusModal() {
            editingStatusId = null;
            document.getElementById('statusModalTitle').textContent = 'Nuovo Stato Pipeline';
            document.getElementById('statusName').value = '';
            document.getElementById('statusColor').value = '#0067A0';
            document.getElementById('statusOrder').value = statuses.length + 1;
            openModal('newStatusModal');
        }
        
        function editStatus(statusId) {
            const status = statuses.find(s => s.id === statusId);
            if (!status) return;
            
            editingStatusId = statusId;
            document.getElementById('statusModalTitle').textContent = 'Modifica Stato';
            document.getElementById('statusName').value = status.name;
            document.getElementById('statusColor').value = status.color;
            document.getElementById('statusOrder').value = status.order;
            openModal('newStatusModal');
        }
        
        async function saveStatus() {
            const name = document.getElementById('statusName').value.trim();
            const color = document.getElementById('statusColor').value;
            const order = parseInt(document.getElementById('statusOrder').value) || 1;
            
            if (!name) {
                showToast('Inserisci il nome dello stato', 'error');
                return;
            }
            
            const statusData = { name, color, order };
            
            if (editingStatusId) {
                await db.collection('statuses').doc(editingStatusId).update(statusData);
                showToast('Stato aggiornato');
            } else {
                const id = name.toLowerCase().replace(/\s+/g, '-');
                await db.collection('statuses').doc(id).set({ id, ...statusData });
                showToast('Stato creato');
            }
            
            closeModal('newStatusModal');
        }
        
        async function deleteStatus(statusId) {
            if (!confirm('Sei sicuro di voler eliminare questo stato?')) return;
            
            // Check if any leads use this status
            const leadsWithStatus = leads.filter(l => l.status === statusId);
            if (leadsWithStatus.length > 0) {
                showToast('Impossibile eliminare: ci sono lead in questo stato', 'error');
                return;
            }
            
            await db.collection('statuses').doc(statusId).delete();
            showToast('Stato eliminato');
        }
        
        // Import/Export
        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const collaboratorId = document.getElementById('importCollaborator').value;
            if (!collaboratorId) {
                showToast('Seleziona un collaboratore prima di importare', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    let imported = 0;
                    
                    for (const row of rows) {
                        const leadData = {
                            company: row['Nome Azienda'] || row['nome azienda'] || row['Azienda'] || '',
                            city: row['Città'] || row['citta'] || row['City'] || '',
                            revenue: parseFloat(row['Fatturato'] || row['fatturato'] || 0) || 0,
                            phone1: String(row['Telefono 1'] || row['telefono 1'] || row['Telefono1'] || ''),
                            phone2: String(row['Telefono 2'] || row['telefono 2'] || row['Telefono2'] || ''),
                            phone3: String(row['Telefono 3'] || row['telefono 3'] || row['Telefono3'] || ''),
                            collaboratorId: collaboratorId,
                            status: 'nuovo',
                            notes: '',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            history: [{
                                date: new Date().toISOString(),
                                action: 'Lead importato da Excel',
                                user: currentUser.fullName
                            }]
                        };
                        
                        if (leadData.company) {
                            await db.collection('leads').add(leadData);
                            imported++;
                        }
                    }
                    
                    showToast(`${imported} lead importati con successo`, 'success');
                    event.target.value = '';
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Errore durante l\'importazione', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function exportLeadsOK() {
            const leadsOK = leads.filter(l => l.status === 'lead-ok');
            
            if (leadsOK.length === 0) {
                showToast('Nessun Lead OK da esportare', 'error');
                return;
            }
            
            const exportData = leadsOK.map(lead => {
                const collaborator = users.find(u => u.id === lead.collaboratorId);
                return {
                    'Nome Azienda': lead.company,
                    'Città': lead.city,
                    'Fatturato': lead.revenue,
                    'Telefono 1': lead.phone1,
                    'Telefono 2': lead.phone2,
                    'Telefono 3': lead.phone3,
                    'Note': lead.notes,
                    'Collaboratore': collaborator?.fullName || '',
                    'Data Lead OK': formatDate(lead.updatedAt)
                };
            });
            
            downloadExcel(exportData, 'lead-ok-export');
        }
        
        function exportAllLeads() {
            if (leads.length === 0) {
                showToast('Nessun lead da esportare', 'error');
                return;
            }
            
            const exportData = leads.map(lead => {
                const collaborator = users.find(u => u.id === lead.collaboratorId);
                const status = statuses.find(s => s.id === lead.status);
                return {
                    'Nome Azienda': lead.company,
                    'Città': lead.city,
                    'Fatturato': lead.revenue,
                    'Telefono 1': lead.phone1,
                    'Telefono 2': lead.phone2,
                    'Telefono 3': lead.phone3,
                    'Note': lead.notes,
                    'Stato': status?.name || lead.status,
                    'Collaboratore': collaborator?.fullName || '',
                    'Data Creazione': formatDate(lead.createdAt)
                };
            });
            
            downloadExcel(exportData, 'tutti-lead-export');
        }
        
        function downloadExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Lead');
            XLSX.writeFile(wb, `${filename}-${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('File esportato con successo', 'success');
        }
        
        // Search
        function handleGlobalSearch() {
            const query = document.getElementById('globalSearch').value.toLowerCase();
            
            if (!query) {
                renderPipeline();
                return;
            }
            
            // Filter leads based on search
            const searchResults = leads.filter(lead => 
                lead.company.toLowerCase().includes(query) ||
                (lead.city && lead.city.toLowerCase().includes(query)) ||
                (lead.phone1 && lead.phone1.includes(query))
            );
            
            // Show results in pipeline
            // For simplicity, we'll just highlight matching cards
            document.querySelectorAll('.lead-card').forEach(card => {
                const leadId = card.dataset.id;
                const isMatch = searchResults.some(l => l.id === leadId);
                card.style.opacity = isMatch ? '1' : '0.3';
            });
        }
        
        // Utility Functions
        function getInitials(name) {
            return name.split(' ').map(n => n.charAt(0)).join('').toUpperCase().substring(0, 2);
        }
        
        function formatCurrency(value) {
            if (!value) return 'N/D';
            return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(value);
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        function getStatusName(statusId) {
            const status = statuses.find(s => s.id === statusId);
            return status?.name || statusId;
        }
        
        function getStatusIcon(statusId) {
            const icons = {
                'nuovo': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
                'non-risponde': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="23" x2="17" y1="1" y2="7"/><line x1="17" x2="23" y1="1" y2="7"/><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
                'non-risponde-2': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="23" x2="17" y1="1" y2="7"/><line x1="17" x2="23" y1="1" y2="7"/><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
                'non-risponde-3': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="23" x2="17" y1="1" y2="7"/><line x1="17" x2="23" y1="1" y2="7"/><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
                'mai-reperibile': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>',
                'non-interessato': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>',
                'lead-ok': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>'
            };
            return icons[statusId] || icons['nuovo'];
        }
        
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = 'toast active';
            if (type) toast.classList.add(type);
            toastMessage.textContent = message;
            
            setTimeout(() => {
                toast.classList.remove('active', 'success', 'error');
            }, 3000);
        }
    </script>
</body>
</html>
